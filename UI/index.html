<HTML> 
	<HEAD>
		<link rel="stylesheet" type="text/css" href="/UI/style.css">
		<script src="/socket.io/socket.io.js"></script>
		<SCRIPT type="text/javascript">
		 
		 //socket functions for communication and event handling from the server
		 //PRD
			var socketConnectionURL = "http://boiling-meadow-5174.herokuapp.com/";
			if (window.location.toString().indexOf("localhost")>=0)
			{
				//localhost
				socketConnectionURL ="http://localhost:8080";
			}
		 var socket = io.connect(socketConnectionURL);
		 
		 socket.on('connect', function (data) {
			//alert('client is connected');
		  });
		  
		  socket.on('playerListUpdate', function (data) {
			//alert('playerListUpdate');
			drawNames(data);
		  });
		  
		  socket.on('finalBoardUpdate', function (data) {
			//debugDiv.innerHTML = JSON.stringify(data);
			receiveData(data);
			//renderBoard(data); // this isnt working, not sure why it doesnt draw the board correctly
			//receiveData(JSON.stringify(data)); // nope doesnt work either
			
		  });
		  
		  socket.on('partialBoardUpdate', function (data) {
			writeCounter++;
			myVar=setTimeout(function(){
				//writeDebug(data);
				receiveData(data);
			},writeCounter*1000);
		  });
		
		//store global variable
		var namesArray;
		var trackLength = 8;
		var writeCounter = 0;
		var started=false;
		
		//javascript helper functions
		function writeDebug(data)
		{
			var debugDiv = document.getElementById('debugDiv');
			debugDiv.innerHTML += JSON.stringify(data) + '<br/>';
			return;
		}
		
		//init function sets up the inital layout of the page
		function init()
		{
			document.getElementById('init').hidden=false;
			document.getElementById('game').hidden=true;
			document.getElementById('results').hidden=true;
			namesArray = {};
			namesList.innerHTML = "";
		}
		
		function receiveData(gameObject)
		{
			//gameObject = JSON.parse(gameObject);
			//Writes game object to page
			
			var winner = -1;
			for (var i = 0; i<Object.keys(namesArray).length; i++)
			{
				namesArray[Object.keys(namesArray)[i]] = gameObject[Object.keys(namesArray)[i]];
				if (namesArray[Object.keys(namesArray)[i]] == trackLength-1)
					winner=i;
				if (!started && namesArray[Object.keys(namesArray)[i]] != 0)
				{
					started = true;
					startGame();
				}
			}
			drawNames();
			renderBoard();
			if (winner != -1)
			{
				setTimeout(function(){
					showResults(winner);
				}, 1000);
			}
		}
		function fakeData()
		{
			var data = {};
			for (var i = 0; i<Object.keys(namesArray).length; i++)
				data[Object.keys(namesArray)[i]] = namesArray[Object.keys(namesArray)[i]];
			var rnd = Math.floor(Math.random()*Object.keys(namesArray).length);
			data[Object.keys(data)[rnd]]++;
			receiveData(JSON.stringify(data));
		}
		
		function renderBoard(inputNamesArray)
		{
			if (inputNamesArray)
			{
				namesArray = inputNamesArray;
			}
			var grid = document.getElementById('gameBoard');
			grid.innerHTML = "";
			
			//now construct our table
			//for now hardcode it to be 8 rows and n columns
				// Object.keys(namesArray).length is n
			//horse position determined by 8-m where m is value associated with player
			          	 
		   			   
			for (var i = 0; i < 8; i++)
				grid.innerHTML += "<col width= '30px'>";
			grid.innerHTML += "<tbody id='tableBody'></tbody>";
			var gridTest = document.getElementById("tableBody");
			var html = "";
			
			html += "<tr><td class='border' colspan='" + Object.keys(namesArray).length + "'>";
			for( var k = 0; k < Object.keys(namesArray).length ; k++)
				html += "------";
			html += "</td></tr>";
			
			gridTest.innerHTML += html;  
			for (var i = 0; i < 8; i++)
			{
				gridTest.innerHTML += "<tr>";
				html = "";
				for (var j = 0; j < Object.keys(namesArray).length; j++)
				{
					if (namesArray[Object.keys(namesArray)[j]] == 7-i)
					{
						html += "<td>";
						html +=  "|  <a class='hasPlayer'>" + (j+1) + "</a>|" ;
					}
					else
					{
						html += "<td>";
						html += "| . |";
					}
					html += "</td>";
				}
				gridTest.innerHTML += html + "</tr>";
			}
			html = "";
			html += "<tr><td class='border' colspan='" + Object.keys(namesArray).length + "'>";
			for( var k = 0; k < Object.keys(namesArray).length ; k++)
				html += "------";
			html += "</td></tr>";
			gridTest.innerHTML += html; 
				
	          
			return;
		}
		
		function addName ()
		{
		
			var name = document.getElementById('nameInputBox');
			//TODO: SEND LIST OF NAMES TO SERVER
			//JSON.stringify(namesArray);
			socket.emit('join',name.value);
			
			
			if (Object.keys(namesArray).length>=6)
			{
				alert("Sorry, this game has a max of 6 players.");
			}
			else if (namesArray[name.value] == 0)
			{
				alert("Sorry, no duplicate names allowed");
			}
			else
			{
				namesArray[name.value]=0;
				name.value = "";
				drawNames();
			}
			
			
		}
		
		function drawNames(inputNamesArray)
		{
			if (inputNamesArray)
			{
				namesArray = inputNamesArray;
			}
			var namesList = document.getElementById('namesList');
			namesList.innerHTML = "";
			for (var i = 0; i<Object.keys(namesArray).length; i++)
				namesList.innerHTML += "<li>" + Object.keys(namesArray)[i] + "</li>";	
			
		}
		
		function startGame()
		{
			if (Object.keys(namesArray).length <=1)
			{
				alert("Need at least two players to play!");
				exit;
			}
			document.getElementById('init').hidden=true;
			document.getElementById('game').hidden=false;
			
			socket.emit('startGame',name.value);
			
			renderBoard();
			//send list of all player objects to server
			//alert(JSON.stringify(namesArray));
			return;
			
		}
		
		function showResults(winnerVal)
		{
			document.getElementById('game').hidden=true;
			document.getElementById('results').hidden=false;
			document.getElementById('winner').innerHTML = "Winner was: <a id='winningPlayer'>" + Object.keys(namesArray)[winnerVal] + "</a>";
		}
		
		</SCRIPT>
	</HEAD>
	<BODY>
		
		<div id="init">
			Enter your Name: <input type="text" id='nameInputBox' onkeydown="if (event.keyCode == 13) addName()" />
			<br />
			<input type="button"class="add" value ="Add Name" onclick="addName()"/>
			<input type="button" class="button" value="Start Game" onclick="startGame()"/>
		</div>
		<div id="game">
			<table id="gameBoard" border="0">
			</table>
		</div>
		<div id="results">
			<p id="winner"></p>
			<input type="button" class="end" value="New Game" onclick="init()"/>
			<br /> <br />
		</div>
		<div id="players">Players:
			<ol id="namesList"></ol>
		</div>
		<div id= "debugDiv" style="border:2px"></div>
		<!-- quick script call to init -->
		<script type="text/javascript">init();</script>
	</BODY>
</HTML>
